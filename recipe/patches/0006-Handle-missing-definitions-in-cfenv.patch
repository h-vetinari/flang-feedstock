From 0001edcd9ab3738ceaf17ac959642b368a432f1d Mon Sep 17 00:00:00 2001
From: serge-sans-paille <sguelton@mozilla.com>
Date: Fri, 9 Aug 2024 08:32:44 +0200
Subject: [PATCH 6/7] Handle missing definitions in <cfenv>

See https://github.com/llvm/llvm-project/pull/101242
---
 flang/runtime/edit-input.cpp | 8 ++++++++
 flang/runtime/exceptions.cpp | 9 +++++++++
 flang/runtime/stop.cpp       | 9 +++++++++
 3 files changed, 26 insertions(+)

diff --git a/flang/runtime/edit-input.cpp b/flang/runtime/edit-input.cpp
index 37989bbcee0a..2814b51f7a72 100644
--- a/flang/runtime/edit-input.cpp
+++ b/flang/runtime/edit-input.cpp
@@ -16,6 +16,14 @@
 #include <algorithm>
 #include <cfenv>
 
+#ifdef __EMSCRIPTEN__
+#define FE_UNDERFLOW 0
+#define FE_OVERFLOW 0
+#define FE_INEXACT 0
+#define FE_INVALID 0
+#define FE_DIVBYZERO 0
+#define FE_ALL_EXCEPT 0
+#endif
 namespace Fortran::runtime::io {
 RT_OFFLOAD_API_GROUP_BEGIN
 
diff --git a/flang/runtime/exceptions.cpp b/flang/runtime/exceptions.cpp
index dfd3b812e22a..ddde854415b3 100644
--- a/flang/runtime/exceptions.cpp
+++ b/flang/runtime/exceptions.cpp
@@ -13,6 +13,15 @@
 #include "flang/Runtime/magic-numbers.h"
 #include <cfenv>
 
+#ifdef __EMSCRIPTEN__
+#define FE_UNDERFLOW 0
+#define FE_OVERFLOW 0
+#define FE_INEXACT 0
+#define FE_INVALID 0
+#define FE_DIVBYZERO 0
+#define FE_ALL_EXCEPT 0
+#endif
+
 #ifndef __FE_DENORM
 #define __FE_DENORM 0 // denorm is nonstandard
 #endif
diff --git a/flang/runtime/stop.cpp b/flang/runtime/stop.cpp
index 98324da1d91e..1f12b604ff82 100644
--- a/flang/runtime/stop.cpp
+++ b/flang/runtime/stop.cpp
@@ -16,6 +16,15 @@
 #include <cstdio>
 #include <cstdlib>
 
+#ifdef __EMSCRIPTEN__
+#define FE_UNDERFLOW 0
+#define FE_OVERFLOW 0
+#define FE_INEXACT 0
+#define FE_INVALID 0
+#define FE_DIVBYZERO 0
+#define FE_ALL_EXCEPT 0
+#endif
+
 extern "C" {
 
 static void DescribeIEEESignaledExceptions() {
